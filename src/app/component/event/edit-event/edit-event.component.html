<!-- edit-event.component.html - VERSION SIMPLIFIÉE -->
@if (isVisible) {
<div class="modal-overlay" (click)="closeModal()">
  <!-- Affiche le contenu seulement si le formulaire est prêt -->
  @if (eventForm){
  <div class="modal-content" (click)="$event.stopPropagation()">

    <header class="modal-header">
      <!-- Affiche "Modifier" ou "Créer" selon le mode -->
      <h2>{{ isEditMode ? 'Modifier' : 'Créer' }} l'Événement</h2>
      <button class="close-btn" (click)="closeModal()" title="Fermer">
        <lucide-icon name="x" size="20"></lucide-icon>
      </button>
    </header>

    <main class="modal-body">
      <!-- LIAISON PRINCIPALE : Le formulaire HTML est lié au FormGroup 'eventForm' du TS -->
      <form [formGroup]="eventForm" novalidate>

        <!-- Titre & Lieu -->
        <div class="form-row">
          <div class="form-group">
            <label for="nom">Titre</label>
            <!-- LIAISON CHAMP : Cet input est lié au contrôle 'nom' dans 'eventForm' -->
            <input id="nom" type="text" formControlName="nom" />
            <!-- *** Section erreurs supprimée pour simplifier *** -->
          </div>
          <div class="form-group">
            <label for="location">Lieu</label>
            <!-- LIAISON CHAMP : Cet input est lié au contrôle 'location' -->
            <input id="location" type="text" formControlName="location" />
            <!-- *** Section erreurs supprimée pour simplifier *** -->
          </div>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="description">Description</label>
          <!-- LIAISON CHAMP : Ce textarea est lié au contrôle 'description' -->
          <textarea id="description" rows="5" formControlName="description"></textarea>
          <!-- *** Section erreurs supprimée pour simplifier *** -->
        </div>

        <!-- Dates -->
        <div class="form-row">
          <div class="form-group">
            <label for="start">Date et Heure de début</label>
            <!-- LIAISON CHAMP : Cet input est lié au contrôle 'start' -->
            <input id="start" type="datetime-local" formControlName="start" />
            <!-- *** Section erreurs supprimée pour simplifier *** -->
          </div>
          <div class="form-group">
            <label for="end">Date et Heure de fin</label>
            <!-- LIAISON CHAMP : Cet input est lié au contrôle 'end' -->
            <input id="end" type="datetime-local" formControlName="end" />
            <!-- *** Section erreurs supprimée pour simplifier *** -->
            <!-- *** Section erreur validateur global supprimée pour simplifier *** -->
          </div>
        </div>

        <!-- Catégories -->
        <div class="form-group">
          <label>Catégories</label>

          <!-- LIAISON LISTE : Ce div contient la liste liée au FormArray 'categories' -->
          <div formArrayName="categories" class="scroll">

            <!-- Boucle pour afficher chaque catégorie dans le FormArray -->
            <!-- 'categoryCtrl' est une variable temporaire pour chaque groupe, 'i' est l'index (0, 1, 2...) -->
            @for (categoryCtrl of categoriesFormArray.controls; track i; let i = $index) {
            <div [formGroupName]="i" class="category-item">
              <!-- LIAISON GROUPE LISTE : Chaque ligne est liée à un FormGroup dans le FormArray (index 0, 1, 2...) -->

              <div class="category-inputs">
                <div class="form-group category-name">
                  <label for="cat-nom-{{i}}" class="sr-only">Nom catégorie {{i+1}}</label>
                  <!-- LIAISON CHAMP LISTE : Input lié au contrôle 'nom' DANS le groupe de cette catégorie -->
                  <input id="cat-nom-{{i}}" type="text" placeholder="Nom catégorie" formControlName="nom" />
                  <!-- *** Section erreurs supprimée pour simplifier *** -->
                </div>
                <div class="form-group category-capacity">
                  <label for="cat-cap-{{i}}" class="sr-only">Capacité catégorie {{i+1}}</label>
                  <!-- LIAISON CHAMP LISTE : Input lié au contrôle 'capacite' DANS le groupe de cette catégorie -->
                  <input id="cat-cap-{{i}}" type="number" min="0" placeholder="Capacité" formControlName="capacite" />
                  <!-- *** Section erreurs supprimée pour simplifier *** -->
                </div>
              </div>

              <!-- Bouton pour supprimer CETTE ligne catégorie -->
              <button type="button" class="btn btn-outline btn-delete-category" (click)="removeCategory(i)" title="Supprimer cette catégorie">
                <lucide-icon name="trash-2" size="16"></lucide-icon>
              </button>
            </div>
            }
            <!-- Message si aucune catégorie n'est dans la liste -->
            @if (categoriesFormArray.length === 0) {
            <div class="no-categories-message">
              Aucune catégorie définie. Cliquez sur "Ajouter" pour en créer une.
            </div>
            }
            <!-- *** Section erreur FormArray supprimée pour simplifier *** -->
          </div>

          <!-- Bouton pour ajouter une nouvelle catégorie (vide) -->
          <div class="category-actions">
            <button type="button" class="btn btn-primary" (click)="addCategory()">
              <lucide-icon name="circle-plus" size="16"></lucide-icon> Ajouter une catégorie
            </button>
          </div>
        </div>

      </form> <!-- Fin du formulaire -->
    </main>

    <footer class="modal-footer">
      <!-- Bouton Annuler -->
      <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="isSaving">
        <lucide-icon name="circle-x" size="16"></lucide-icon> Annuler
      </button>
      <!-- Bouton Enregistrer (désactivé si sauvegarde en cours) -->
      <!-- Note: On a enlevé [disabled]="eventForm.invalid" pour l'instant pour simplifier -->
      <button type="button" class="btn btn-primary" (click)="saveChanges()" [disabled]="isSaving">
        @if (!isSaving){<lucide-icon name="save" size="16"></lucide-icon>}
        @if (isSaving){<lucide-icon name="loader-circle" size="16" class="animate-spin"></lucide-icon>}
        {{ isSaving ? 'Sauvegarde...' : 'Enregistrer' }}
      </button>
    </footer>

  </div>
  }
</div>
  }

