<!-- mon-compte.component.html - Refactorisé en respectant paste.txt -->

<!-- Classe standardisée pour le conteneur principal -->
<div class="main-content-area">

  <div class="page-header account-header"> <!-- Ajout classe page-header pour spécificité -->
    <h1><lucide-icon name="user-cog" aria-hidden="true"></lucide-icon> Mon Compte</h1>
    <!-- Ajout type="button" et classe btn btn-secondary pour style cohérent -->
    <a (click)="auth.deconnexion()" routerLink="/accueil" class="logout-btn btn btn-secondary" title="Déconnexion">
      <lucide-icon name="log-out" aria-hidden="true"></lucide-icon>
      <span class="visually-hidden">Déconnexion</span>
    </a>
  </div>

  @if (!isLoading) {
    <!-- Utilisation de <main> pour le contenu principal -->
    <main role="main">
      <!-- Conservation du conteneur .section-cards si utilisé pour espacement/mise en page -->
      <div class="section-cards">

        <!-- FORMULAIRE #1 : Informations Personnelles et Adresse -->
        <form [formGroup]="infoForm" (ngSubmit)="updatePersonalInfo()" class="account-form" novalidate>
          <!-- Utilisation de fieldset pour regrouper la section -->
          <fieldset class="account-section card-section">
            <!-- Le header devient la legend -->
            <legend class="section-header">
              <h2><lucide-icon name="user" aria-hidden="true"></lucide-icon> Informations personnelles</h2>
              <p class="section-description">Vos informations personnelles principales</p>
            </legend>

            <div class="card-content">
              <!-- Ligne Prénom, Nom, Date Naissance -->
              <div class="form-row">
                <div class="form-group third">
                  <label for="firstname">Prénom</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type="text" id="firstname" formControlName="prenom" aria-required="true" aria-describedby="prenom-error"/>
                  <!-- Structure pour erreur (vide pour l'instant) -->
                  <div id="prenom-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
                <div class="form-group third">
                  <label for="lastname">Nom</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type="text" id="lastname" formControlName="nom" aria-required="true" aria-describedby="nom-error"/>
                  <!-- Structure pour erreur -->
                  <div id="nom-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
                <div class="form-group third">
                  <label for="birthdate">Date de naissance</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type="date" id="birthdate" formControlName="date_naissance" aria-required="true" aria-describedby="date_naissance-error"/>
                  <!-- Structure pour erreur -->
                  <div id="date_naissance-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
              </div>

              <!-- Ligne Email, Téléphone -->
              <div class="form-row">
                <div class="form-group half">
                  <label for="email">Email</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type="email" id="email" formControlName="email" aria-required="true" aria-describedby="email-error"/>
                  <!-- Structure pour erreur -->
                  <div id="email-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
                <div class="form-group half">
                  <label for="phone">Téléphone</label>
                  <!-- Ajout aria-describedby -->
                  <input type="tel" id="phone" formControlName="telephone" aria-describedby="telephone-error"/>
                  <!-- Structure pour erreur -->
                  <div id="telephone-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
              </div>

              <!-- Correction: La section Adresse devient un fieldset séparé mais DANS le même formulaire -->
              <!-- Ce header est maintenant une legend dans le fieldset ci-dessous -->
              <!--
              <div class='section-header'>
                <h2><lucide-icon name='map-pin' aria-hidden="true"></lucide-icon> Adresse</h2>
                <p class='section-description'>Votre adresse postale complète</p>
              </div>
              -->

            </div> <!-- Fin card-content pour infos perso -->
          </fieldset> <!-- Fin fieldset infos perso -->

          <!-- Fieldset pour Adresse (toujours dans infoForm) -->
          <fieldset class="account-section card-section">
            <legend class="section-header">
              <h2><lucide-icon name='map-pin' aria-hidden="true"></lucide-icon> Adresse</h2>
              <p class='section-description'>Votre adresse postale complète</p>
            </legend>
            <div class="card-content">
              <!-- Ligne pour numéro et rue -->
              <div class='form-row'>
                <div class='form-group quarter'>
                  <label for='street-number'>N°</label>
                  <!-- Ajout aria-describedby -->
                  <input type='text' id='street-number' formControlName='numero_voie' aria-describedby="numero_voie-error"/>
                  <!-- Structure pour erreur -->
                  <div id="numero_voie-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
                <div class='form-group three-quarters'>
                  <label for='street'>Rue</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type='text' id='street' formControlName='rue' aria-required="true" aria-describedby="rue-error"/>
                  <!-- Structure pour erreur -->
                  <div id="rue-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
              </div>

              <!-- Ligne pour code postal et ville -->
              <div class='form-row'>
                <div class='form-group half'>
                  <label for='postal-code'>Code postal</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type='text' id='postal-code' formControlName='codepostal' aria-required="true" aria-describedby="codepostal-error postal-format-hint"/>
                  <!-- Structure pour aide et erreur -->
                  <small id="postal-format-hint" class="form-text text-muted">Format: 5 chiffres</small>
                  <div id="codepostal-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
                <div class='form-group half'>
                  <label for='city'>Ville</label>
                  <!-- Ajout aria-required, aria-describedby -->
                  <input type='text' id='city' formControlName='ville' aria-required="true" aria-describedby="ville-error"/>
                  <!-- Structure pour erreur -->
                  <div id="ville-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
              </div>

              <!-- Bouton Mettre à jour pour TOUT infoForm (incluant adresse) -->
              <!-- Le bouton était mal placé dans votre HTML initial (dans la section info perso),
                   on le met à la fin du formulaire -->
              <div class="form-actions"> <!-- Conteneur pour les boutons du formulaire -->
                <button type="submit" class='btn btn-primary' [disabled]="infoForm.invalid || infoForm.pending || !infoForm.dirty">
                  <lucide-icon name="save" aria-hidden="true"></lucide-icon> <!-- Ajout icône pour cohérence -->
                  Mettre à jour mes informations
                </button>
              </div>
            </div><!-- Fin card-content pour adresse -->
          </fieldset> <!-- Fin fieldset adresse -->

        </form> <!-- Fin du formulaire infoForm -->


        <!-- Formulaire Changer le mot de passe (conservé commenté comme dans votre source) -->
        <!--
        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="account-form" novalidate>
          <fieldset class="account-section card-section">
            <legend class="section-header">
              <h2><lucide-icon name='lock' aria-hidden="true"></lucide-icon> Changer le mot de passe</h2>
              <p class="section-description">Mettez à jour votre mot de passe pour sécuriser votre compte.</p>
            </legend>
            <div class="card-content">
              <div class="form-group">
                <label for="current-password">Mot de passe actuel</label>
                <input type="password" id="current-password" formControlName="current_password" aria-required="true" aria-describedby="current_password-error"/>
                <div id="current_password-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
              </div>

              <div class="form-row"> --> <!-- Conservé pour layout -->
        <!-- <div class="form-grid columns-2"> --> <!-- Alternative avec Grid -->
        <!--        <div class="form-group half"> --> <!-- Conservé pour layout -->
        <!--          <label for="new-password">Nouveau mot de passe</label>
                  <input type="password" id="new-password" formControlName="new_password" aria-required="true" aria-describedby="new_password-error"/>
                  <div id="new_password-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
                <div class="form-group half"> --> <!-- Conservé pour layout -->
        <!--          <label for="confirm-password">Confirmer le nouveau mot de passe</label>
                  <input type="password" id="confirm-password" formControlName="confirm_password" aria-required="true" aria-describedby="confirm_password-error"/>
                  <div id="confirm_password-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class='btn btn-secondary' [disabled]="passwordForm.invalid || passwordForm.pending || !passwordForm.dirty">
                   <lucide-icon name="key-round" aria-hidden="true"></lucide-icon> <!-/- Ajout icône ->
                  Changer le mot de passe
                </button>
              </div>
            </div>
          </fieldset>
        </form>
        -->

      </div> <!-- Fin .section-cards -->
    </main> <!-- Fin main -->
  } <!-- Fin @if (!isLoading) pour les formulaires -->

  <!-- ZONE DANGEREUSE - Suppression de compte (hors des formulaires principaux) -->
  @if (!isLoading) {
    <!-- Utilisation de <section> pour la sémantique -->
    <section class="account-section danger-zone card-section" aria-labelledby="danger-zone-title">
      <div class="section-header">
        <h2 id="danger-zone-title"><lucide-icon name="triangle-alert" aria-hidden="true"></lucide-icon> Zone Dangereuse</h2>
      </div>
      <div class="card-content">
        <p>Supprimer votre compte est une action <strong>irréversible</strong>. Toutes vos données, réservations, amitiés et informations seront définitivement anonymisées.</p>

        @if (!showDeleteConfirmation) {
          <!-- Ajout type="button" -->
          <button type="button" class="btn btn-danger" (click)="initiateAccountDeletion()">
            Supprimer mon compte
          </button>
        } @else {
          <!-- Ajout rôles ARIA pour accessibilité -->
          <div class="confirmation-section" role="alertdialog" aria-labelledby="confirm-delete-title" aria-describedby="confirm-delete-desc">
            <h3 id="confirm-delete-title" class="visually-hidden">Confirmation de suppression de compte</h3>
            <p id="confirm-delete-desc" class="confirmation-prompt">Pour confirmer la suppression définitive de votre compte, veuillez taper la phrase suivante exactement comme indiqué ci-dessous :</p>
            <!-- Ajout classe non-selectable pour la phrase -->
            <p class="confirmation-phrase non-selectable" aria-hidden="true"><strong>{{ requiredConfirmationPhrase }}</strong></p>

            <div class="form-group">
              <label for="delete-confirm-input">Tapez la phrase ici :</label>
              <!-- Conservation de [(ngModel)] mais ajout aria-required et aria-describedby -->
              <input type="text"
                     id="delete-confirm-input"
                     class="form-control"
                     [(ngModel)]="deleteConfirmationInput"
                     placeholder="Recopiez la phrase de confirmation"
                     autocomplete="off"
                     aria-required="true"
                     aria-describedby="delete-confirm-error"
              />
              <!-- Structure pour erreur (vide, la logique de désactivation du bouton suffit peut-être) -->
              <div id="delete-confirm-error" class="invalid-feedback" role="alert" aria-live="assertive"></div>
            </div>

            <div class="confirmation-actions">
              <!-- Ajout type="button" -->
              <button type="button" class="btn btn-secondary" (click)="cancelAccountDeletion()" [disabled]="isDeletingAccount">
                Annuler
              </button>
              <!-- Ajout type="button" -->
              <button type="button"
                      class="btn btn-danger"
                      (click)="confirmAccountDeletion()"
                      [disabled]="isDeletingAccount || deleteConfirmationInput !== requiredConfirmationPhrase">
                @if (!isDeletingAccount) {
                  <!-- Ajout icône pour cohérence -->
                  <span><lucide-icon name="trash-2" aria-hidden="true"></lucide-icon> Confirmer la suppression</span>
                } @else {
                  <!-- Ajout icône pour cohérence -->
                  <span><lucide-icon name="loader" class="animate-spin" aria-hidden="true"></lucide-icon> Suppression en cours...</span>
                }
              </button>
            </div>
          </div>
        } <!-- Fin du @else (confirmation visible) -->
      </div> <!-- Fin card-content -->
    </section> <!-- Fin danger-zone -->
  } <!-- Fin du @if (!isLoading) pour la danger-zone -->

</div> <!-- Fin .main-content-area -->
