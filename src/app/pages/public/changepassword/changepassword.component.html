<div class="contenu">


<!-- En-tête de la page -->

<div class="page-header">
  <!-- Icône appropriée pour la réinitialisation -->
  <i data-lucide="shield-check" aria-hidden="true"></i>
  <h1 class="page-title">Définir un nouveau mot de passe</h1>
</div>

<!-- Section principale -->
<section class="main-section">
  <h2 id="main-title" class="visually-hidden">Formulaire de définition du nouveau mot de passe</h2>

  <!-- Affichage conditionnel basé sur l'état de vérification du token -->

  <!-- État d'attente de vérification -->
  <div *ngIf="currentState === 'Wait'" class="loading-indicator card">
    <span class="animate-spin"><i data-lucide="loader-circle"></i></span>
    <span>Vérification du lien en cours...</span>
  </div>

  <!-- État : Token invalide ou expiré -->
  <div *ngIf="currentState === 'NotVerified' || currentState === 'TokenError'" class="card-section danger-zone">
    <legend class="section-header">
      <h2><i data-lucide="alert-triangle" aria-hidden="true"></i> Lien invalide</h2>
    </legend>
    <div class="card-content">
      <div class="alert alert-danger" role="alert">
        {{ errorMessage || 'Ce lien de réinitialisation de mot de passe est invalide, a expiré ou a déjà été utilisé.' }}
      </div>
      <div class="auth-link">
        <a routerLink="/forgotpassword">Demander un nouveau lien</a> <!-- Adaptez '/forgot-password' -->
      </div>
    </div>
  </div>

  <!-- État : Token vérifié, affichage du formulaire -->
  <form *ngIf="currentState === 'Verified'" [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" novalidate>
    <fieldset class="card-section">
      <legend class="section-header">
        <h2>Nouveau mot de passe</h2>
        <p class="section-description">Veuillez entrer et confirmer votre nouveau mot de passe.</p>
      </legend>

      <div class="card-content">

        <!-- Affichage des messages d'erreur/succès généraux du formulaire -->
        <div *ngIf="errorMessage && !isVerifyingToken" class="alert alert-danger" role="alert">
          {{ errorMessage }}
        </div>
        <div *ngIf="successMessage" class="alert alert-success" role="alert">
          {{ successMessage }}
        </div>

        <!-- Champ Nouveau mot de passe -->
        <div class="form-group">
          <label for="new-password">
            Nouveau mot de passe<span class="required-indicator">*</span>
          </label>
          <input type="password"
                 id="new-password"
                 formControlName="newPassword"
                 class="form-control"
                 [class.is-invalid]="newPassword?.invalid && newPassword?.dirty"
                 required
                 aria-describedby="new-password-error new-password-help">
          <!-- Texte d'aide optionnel -->
          <small id="new-password-help" class="form-text text-muted">
            Doit contenir au moins 8 caractères. <!-- Adaptez selon vos règles -->
          </small>
          <!-- Messages d'erreur -->
          <div id="new-password-error" *ngIf="newPassword?.invalid &&  newPassword?.dirty">
            <small *ngIf="newPassword?.errors?.['required']" class="invalid-feedback">
              Le nouveau mot de passe est requis.
            </small>
            <small *ngIf="newPassword?.errors?.['minlength']" class="invalid-feedback">
              Le mot de passe doit contenir au moins {{ newPassword?.errors?.['minlength'].requiredLength }} caractères.
            </small>
            <!-- Autres messages pour complexité -->
          </div>
        </div>

        <!-- Champ Confirmer le nouveau mot de passe -->
        <div class="form-group">
          <label for="confirm-password">
            Confirmer le nouveau mot de passe<span class="required-indicator">*</span>
          </label>
          <input type="password"
                 id="confirm-password"
                 formControlName="confirmPassword"
                 class="form-control"
                 [class.is-invalid]="confirmPassword?.invalid &&  confirmPassword?.dirty"
                 required
                 aria-describedby="confirm-password-error">
          <!-- Messages d'erreur -->
          <div id="confirm-password-error" *ngIf="confirmPassword?.invalid &&  confirmPassword?.dirty">
            <small *ngIf="confirmPassword?.errors?.['required']" class="invalid-feedback">
              Veuillez confirmer le nouveau mot de passe.
            </small>
            <small *ngIf="confirmPassword?.errors?.['passwordMismatch']" class="invalid-feedback">
              Les mots de passe ne correspondent pas.
            </small>
          </div>
        </div>

      </div> <!-- Fin .card-content -->

      <!-- Actions du formulaire -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isLoading || resetPasswordForm.invalid">
          <span *ngIf="isLoading; else saveText" class="animate-spin" aria-hidden="true">
             <i data-lucide="loader-circle"></i>
          </span>
          <ng-template #saveText>
            <i data-lucide="save" aria-hidden="true"></i>
            Enregistrer le nouveau mot de passe
          </ng-template>
        </button>
      </div>

    </fieldset>
  </form>

  <!-- Lien optionnel si l'utilisateur arrive ici par erreur -->
  <div *ngIf="currentState === 'Verified' && !successMessage" class="auth-link">
    <a routerLink="/login">Retour à la connexion</a> <!-- Adaptez '/login' -->
  </div>

</section>
</div>
